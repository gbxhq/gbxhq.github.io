
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>WebRTC04KurentoDemo流程分析 | 炫杉</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="ixsim">
    

    
    <meta name="description" content="今天的学习可以说是以失败告终了吧。也就知道了用js动态调试。大体看懂了participant.js和conference.js。但最大头的是kurento.js">
<meta name="keywords" content="js">
<meta property="og:type" content="article">
<meta property="og:title" content="WebRTC04KurentoDemo流程分析">
<meta property="og:url" content="https://ixsim.github.io/WebRTC/WebRTC04Kurento流程分析/index.html">
<meta property="og:site_name" content="炫杉">
<meta property="og:description" content="今天的学习可以说是以失败告终了吧。也就知道了用js动态调试。大体看懂了participant.js和conference.js。但最大头的是kurento.js">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-09-03T06:28:51.443Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WebRTC04KurentoDemo流程分析">
<meta name="twitter:description" content="今天的学习可以说是以失败告终了吧。也就知道了用js动态调试。大体看懂了participant.js和conference.js。但最大头的是kurento.js">

    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="炫杉" title="炫杉"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="炫杉">炫杉</a></h1>
				<h2 class="blog-motto">提着鸟笼的老头站在一旁拍我肩膀 我猜他想的应该和我一样</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:ixsim.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/WebRTC/WebRTC04Kurento流程分析/" title="WebRTC04KurentoDemo流程分析" itemprop="url">WebRTC04KurentoDemo流程分析</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ixsim" target="_blank" itemprop="author">ixsim</a>
		
  <p class="article-time">
    <time datetime="2018-08-28T03:19:51.000Z" itemprop="datePublished"> 发表于 2018-08-28</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#关于频繁出现的-ICE-candidate："><span class="toc-number">1.</span> <span class="toc-text">关于频繁出现的 ICE candidate：</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#js调试知识点"><span class="toc-number">2.</span> <span class="toc-text">js调试知识点</span></a></li></ol>
		
		</div>
		
		<blockquote>
<p>今天的学习可以说是以失败告终了吧。也就知道了用js动态调试。大体看懂了participant.js和conference.js。但最大头的是kurento.js</p>
</blockquote>
<a id="more"></a>
<h1 id="关于频繁出现的-ICE-candidate："><a href="#关于频繁出现的-ICE-candidate：" class="headerlink" title="关于频繁出现的 ICE candidate："></a>关于频繁出现的 ICE candidate：</h1><p><strong>ICE</strong> stands for <strong>Interactive Connectivity Establishment</strong> , its a techniques used in NAT( network address translator ) for <code>establishing communication for VOIP, peer-peer, instant-messaging, and other kind of interactive media.</code></p>
<p>Typically <strong>ice candidate</strong> provides the information about the IPaddress and port from where the data is going to be exchanged.</p>
<p>It’s format is something like follows</p>
<p>a=candidate:1 1 <strong>UDP</strong> 2130706431 <strong>192.168.1.102 1816</strong> typ <strong>host</strong></p>
<p>here <code>UDP</code> specifies the protocol to be used, the <code>typ host</code> specifies which type of ice candidates it is, host means the candidates is generated within the firewall. If you use <code>wireshark</code> to monitor the traffic then you can see the ports that are used for data transfer are same as the one present in ice-candidates.</p>
<p>Another type is <code>relay</code> , which denotes this candidates can be used when communication is to be done outside the firewall.</p>
<p>It may contain more information depending on browser you are using. Many time i have seen 8-12 ice-candidates are generated by browser.</p>
<hr>
<p>Every ICE contains ‘a node’ of your network, until it has reached the outside. By this you send these ICE’s to the other peer, so they know through what connection points they can reach you. See it as a large building: one is in the building, and needs to tell the other (who is not familiar) how to walk through it. Same here, if I have a lot of network devices, the incoming connection somehow needs to find the right way to my computer. By providing all nodes, the RTC connection finds the shortest route itself. So when you would connect to the computer next to you, which is connected to the same router/switch/whatever, it uses all ICE’s and determine the shortest, and that is directly through that point. That your collegue got less ICE candidates has to do with the ammount of devices it has to go through. Please note that every network adapter inside your computer which has an IP adress (I have a vEthernet switch from hyper-v) it also creates an ICE for it.</p>
<p>参考链接：<a href="https://stackoverflow.com/a/21071464" target="_blank" rel="noopener">https://stackoverflow.com/a/21071464</a></p>
<p>Demo是王老师搭建了运行在服务器的，先通过给两个主要的js文件(<code>participate.js和conference.js</code>)下断点来弄明白流程吧。</p>
<p><del>我先建立一个房间登录用户banana房间号1234。然后用另一个浏览器进去开始调试。在<code>participant.js</code>第30行下了断点。</del></p>
<ul>
<li><p><del>输入名字apple和房间号1234后，进入<code>Participant(name)</code>函数。name就是apple。仔细看这好像是Participant的类啊。整个<code>participant.js</code>就这一个函数。</del></p>
</li>
<li><p><del>然后这个函数开始写html</del></p>
<p><del>在一个container中把name、video框啥的加入。还会有video一些参数的设置。然后return这个container</del></p>
</li>
<li><p><del>到了<code>conferenceroom.js</code>，有个参与者的数组，下标是name，加入了刚刚的的用户</del></p>
</li>
<li><p><del>回到<code>participant.js</code>读到了banana。又是一系列的写入html。</del></p>
</li>
<li><p><del>然后到了<code>conferenceroom.js</code>的<code>receiveVideo(sender)</code>函数。就是接受sender这个用户发来的Video。</del></p>
<blockquote>
<p><del>一会儿建立一个3人的看看sender会变成啥样。怎么接。</del></p>
</blockquote>
</li>
<li><p><del>跳转到 <code>conference.js</code>的<code>ws.onmessage = function(message)</code>,其中message里面有数据：<code>&quot;id&quot;:&quot;existingParticipants&quot;,&quot;data&quot;:[&quot;banana&quot;]</code>和源<code>origin: &quot;wss://192.168.139.218:8443&quot;</code></del></p>
<p><del>message里的数据是JSON格式的。然后解包存到了<u>parseMessage</u>这个变量。通过<strong>id</strong>判断进去什么case。</del></p>
<p><del>明显我现在是属于存在用户的情况：</del></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">'existingParticipants'</span>:</span><br><span class="line">		onExistingParticipants(parsedMessage);</span><br><span class="line">		<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p><del>下面看具体的<code>onExistingParticipants(parsedMessage);</code>执行了什么:</del></p>
<ul>
<li><del>变量constranits是控制网页video大小的</del></li>
<li><del>控制台输出：apple在房间注册</del></li>
<li><del>新建一个Participate对象</del></li>
</ul>
<p><del>break</del></p>
<hr>
</li>
</ul>
<ul>
<li><p><del>至此图像还没有在网页显示。进入了<code>kurento-utils.js</code>。应该是实现WebRTC的了。</del></p>
</li>
<li><p><del><code>start()</code>函数。不知道为啥，直接到了<code>if (mode !== &#39;recvonly&#39; &amp;&amp; !videoStream &amp;&amp; !audioStream)</code>  –&gt;</del></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">navigator.mediaDevices.getUserMedia(constraints).then(<span class="function"><span class="keyword">function</span> (<span class="params">stream</span>) </span>&#123;</span><br><span class="line">                videoStream = stream;</span><br><span class="line">                start();</span><br><span class="line">            &#125;).catch(callback);</span><br></pre></td></tr></table></figure>
<p><del>其中stream是一个MediaSteam.上午自己看资料看到有MediaSteamAPI。然后又<code>start()</code>有点懵。</del></p>
<hr>
</li>
</ul>
<ul>
<li><p><del>到了<code>window.RTCPeerConnection</code>又是一阵懵之后。</del></p>
</li>
<li><p><del>回到了<code>conference.js`</code>ws.onmessage = funciton(message)<code>解JSON数据包。并出现了apple的画面。此时的messsage里id成了</code>receiveVideoAnser`,通过id判断进入case。</del></p>
</li>
<li><p><del>break后又在ws.onmessage解JSON。id成了<code>&quot;iceCandidate&quot;</code></del></p>
<p><del>进入iceCandidate的case：参与者的数组中取到apple然后<code>.rtcPeer.addIceCandidate()</code>是加入了参与者？但是也没看到读取banana啊。只读到一串这个：<code>&quot;candidate:4 1 UDP 2013266431 2400:dd0a:1005:1390:250:56ff:fe86:a0c4 30325 typ host&quot;</code></del></p>
</li>
<li><p><del>回到了<code>window.RTCPeerConnection</code>执行<code>resolve()</code>解码？</del></p>
</li>
</ul>
<hr>
<p>上面调试遇到一个问题就是，加了断点会在死循环里出不来啊。</p>
<p>我懂了。我应该在每种情况下加不同的断点。然后看代码是怎么走的。就是说我之前折腾这半天顶多就知道了个新建Participate对象的事。重来吧。</p>
<hr>
<ol>
<li>在<code>conference.js</code>的前4个case中下断点</li>
<li>第一个用户apple进入1234房间，分析</li>
<li>第二个用户banana进入1234房间，分析</li>
<li>第三个用户cabbage进入1234房间，分析</li>
<li>第二个用户banana退出1234房间，分析</li>
</ol>
<ul>
<li>第一个用户apple进入1234房间<ul>
<li>虽然之前没有人。但还是进入了existingParticipants情况下。<code>function onExistingParticipants(msg)</code>其中msg中：<code>{id: &quot;existingParticipants&quot;, data: Array(0)}</code></li>
<li>控制台输出，apple在房间注册</li>
<li>新建Participate对象<code>participant = new Participant(name);</code> name就是“apple” ，这个过程会在HTML写入video框，但还没有读到数据</li>
<li>存入数组participants[name]</li>
<li>读video</li>
<li><code>participant.rtcPeer</code> 进入了<code>kurento-utils.js</code>这里面好复杂没看懂</li>
<li>break了<code>case &#39;existingParticipants&#39;</code></li>
<li>通过<code>this.offerToReceiveVideo</code>进入了<code>receiveVideoResponse</code>这个case。<code>receiveVideoResponse(result)</code>其中result内容有id、name和adpAnswer</li>
<li>end？</li>
</ul>
</li>
</ul>
<hr>
<p>又去请教了下王老师。看来我的重点还是要去看</p>
<p><code>kurento-utils.js</code>研究明白这个才是最重要的。</p>
<p>问题的关键就在于我要摸索出什么该看什么不该看。</p>
<hr>
<p>下班后王老师一走。Demo进不去了。找了找文档，想自己搭建一下呢。发现要JDK和mvn。电脑没这么多空间了。贼尴尬。</p>
<p><a href="http://www.kurento.org" target="_blank" rel="noopener">http://www.kurento.org</a></p>
<p>Demo官网。</p>
<blockquote>
<p>后来发现这个Demo是搭建在实验室的服务器上的。必须是Ubuntu环境。</p>
</blockquote>
<h1 id="js调试知识点"><a href="#js调试知识点" class="headerlink" title="js调试知识点"></a>js调试知识点</h1><ul>
<li><p>控制台输入 <code>$(this)</code>即可得到选择的元素</p>
</li>
<li><p>输入变量名可查看这个变量</p>
<blockquote>
<p> 但要在加了断点的情况下才能看到那些局部变量哦</p>
</blockquote>
</li>
<li><p>可以边调试边打断点和去断点啊！</p>
</li>
<li><p>王老师说的对，这东西还是得多调。有了经验了以后就会打了。</p>
</li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/WebRTC/">WebRTC</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/js/">js</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://ixsim.github.io/WebRTC/WebRTC04Kurento流程分析/" data-title="WebRTC04KurentoDemo流程分析 | 炫杉" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/WebRTC/WebRTC05入门教程02/" title="WebRTC05入门教程02">
  <strong>上一篇：</strong><br/>
  <span>
  WebRTC05入门教程02</span>
</a>
</div>


<div class="next">
<a href="/WebRTC/WebRTC03入门教程01/"  title="WebRTC03入门教程01">
 <strong>下一篇：</strong><br/> 
 <span>WebRTC03入门教程01
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#关于频繁出现的-ICE-candidate："><span class="toc-number">1.</span> <span class="toc-text">关于频繁出现的 ICE candidate：</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#js调试知识点"><span class="toc-number">2.</span> <span class="toc-text">js调试知识点</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Blockchain/" title="Blockchain">Blockchain<sup>1</sup></a></li>
		  
		
		  
		
		  
		
		  
			<li><a href="/categories/Others/" title="Others">Others<sup>8</sup></a></li>
		  
		
		  
			<li><a href="/categories/Python/" title="Python">Python<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/WebRTC/" title="WebRTC">WebRTC<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/Website/" title="Website">Website<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS/" title="iOS">iOS<sup>10</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Note/" title="Note">Note<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/Swift/" title="Swift">Swift<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Demo/" title="Demo">Demo<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/LeetCode/" title="LeetCode">LeetCode<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/tips/" title="tips">tips<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/tutorial/" title="tutorial">tutorial<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/js/" title="js">js<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Spider/" title="Spider">Spider<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C++">C++<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo/" title="Hexo">Hexo<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Data-Analysis/" title="Data Analysis">Data Analysis<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Matlab/" title="Matlab">Matlab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/iOS/" title="iOS">iOS<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Git/" title="Git">Git<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Swfit/" title="Swfit">Swfit<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/File-Process/" title="File Process">File Process<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/note/" title="note">note<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/IoT/" title="IoT">IoT<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/selenium/" title="selenium">selenium<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://oo1.win" target="_blank" title="炫猿">炫猿</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.aimoon.site/" target="_blank" title="我大哥">我大哥</a>
            
          </li>
        
          <li>
            
            	<a href="https://onebigcabbage.github.io/" target="_blank" title="小菜哥">小菜哥</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello, <br/>
			World!</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/lixsh" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:xuanshanli@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 
		
		<a href="/about" target="_blank" title="ixsim">ixsim</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'oo1';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>








<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
