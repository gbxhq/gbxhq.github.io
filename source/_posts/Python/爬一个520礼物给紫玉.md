---
title: çˆ¬ä¸€ä¸ª520ç¤¼ç‰©ç»™ç´«ç‰
date: 2018-05-18 13:54:28
categories: Python
tags: [Spider,Demo,Python]
---

520é€ç‚¹å•¥å‘¢ã€‚æœ‰Pythonä¸æ…Œ~å“ˆå“ˆ
æˆ‘ä»¬æ¥è¯•ç€æ‰¾ä¸€è¾†5æœˆ20å·13ç‚¹14çš„åˆ—è½¦å§~

<!---more--->
# ä»åˆ†æåˆ°å®è·µ
## åˆæ¢

ç™¾åº¦äº†ä¸‹åˆ—è½¦æ—¶åˆ»è¡¨ï¼Œæœ‰ä¸ªip138ï¼Œå°±çˆ¬å®ƒå•¦ğŸ¤­ã€‚å…ˆè¯»ä¸€ä¸‹ç¬¬ä¸€é¡µçš„å†…å®¹ï¼š
è¿™ç½‘ç«™å¤ªè€äº†ã€‚ç«Ÿç„¶ä¸æ˜¯UTF-8ç¼–ç çš„ã€‚
è§£ç ï¼š
ä½¿ç”¨urlopenï¼š
`html = urlopen(url).read().decode('GB2312')`

ä½¿ç”¨Requestsï¼š
`r.encode('ISO-8859-1').decode('GB2312')`

OKï¼Œå¯ä»¥æ„‰å¿«åœ°ç©è€å•¦ã€‚

## å¾ªç¯è¯»å…¨éƒ¨åˆ—è½¦æ•°æ®

å…ˆä»ç¬¬ä¸€é¡µå…¥å£è¯»åˆ°æ¯ä¸ªçœçš„æ•°æ®ï¼Œæ ¹æ®aæ ‡ç­¾çš„hrefå±æ€§å¾ˆå®¹æ˜“å‘ç°ä»–ä»¬éƒ½æ˜¯/trainå¼€å¤´çš„ï¼Œæ­£åˆ™æå®šï¼š
`province = soup.find_all('a',{"href":re.compile("/train/")})`
![](../../images/15266465313941.jpg)

ç„¶åä¸€ä¸ªå¾ªç¯å¼€å§‹çˆ¬è¿™ä¸ªçœçš„åŸå¸‚ï¼Œè¿™é‡Œçš„aæ ‡ç­¾éƒ½æ˜¯ä»¥çœä»½çš„æ‹¼éŸ³å¼€å¤´çš„ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸Šä¸€æ­¥çš„æ ‡ç­¾i['href']ï¼š
`city = soup.find_all('a',{"href":re.compile(i['href'])})`
å¤ªå¤šäº†ä¸ä¸Šå›¾äº†ã€‚å¼€å§‹è¯»æ¯ä¸ªåŸå¸‚çš„åˆ—è½¦å’¯ã€‚

ç”±äºæ—¶åˆ»è¡¨è¢«å­˜åœ¨äº†<table>é‡Œï¼Œæ‰€ä»¥å…ˆç”¨<tr>æŠŠæ¯ä¸€è¡Œè·Ÿåˆ†å¼€ã€‚
ç„¶åä»tré‡Œç”¨æ­£åˆ™æ‰¾å†…å®¹æ˜¯ 13:14 çš„tdï¼š
`p=re.compile(r'13:14')`
`if p.search(str(i)):`

è¿™æ—¶å€™å‘ç°ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„13:14éƒ½æ˜¯å‘è½¦çš„æ—¶é—´ï¼Œæ ¹æ®è¡¨æ ¼å†…å®¹ï¼Œç¬¬4æ˜¯å‘è½¦çš„æ—¶é—´ã€‚æˆ‘ä»¬å°±æŠŠç­›å‡ºæ¥çš„æ•°æ®ï¼Œsplitåå†åˆ¤æ–­ä¸€ä¸‹æ˜¯ä¸æ˜¯ç¬¬å…­åˆ—å†…å®¹æ˜¯ 13:14 ï¼Œå¦‚æœæ˜¯å†appendåˆ°answeråˆ—è¡¨ï¼š

```Python
if i.text.split()[3] == '13:14':
    answer.append(i.text)`
```

è‡³æ­¤æ‰€æœ‰çš„ä»£ç åŸºæœ¬å°±å®Œæˆäº†ï¼Œå¯è¿è¡Œèµ·æ¥å‡ºäº†ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¾ªç¯é˜Ÿåˆ—çš„ç½‘é¡µå¤ªå¤šï¼Œè¶…æ—¶äº†æ•´ä¸ªå¾ªç¯éƒ½ä¼šåœæ­¢ï¼Œè€Œä¸”çˆ¬äº†ä¸€æ®µæ—¶å€™åä¸€ç›´è¿”å›HTTP-Errã€‚
è¯·æ•™ä¸‹åŒå­¦ï¼Œå†™äº†ä¸ªTryçš„å‡½æ•°ï¼š

## é˜²æ­¢HTTPè¶…æ—¶

```python
def fun(url):
    result=''
    try:
        result = urlopen(url,timeout=10).read()
    except:
        result = fun(url)
        print('error')
    return result
```
è¿™æ ·ï¼Œå¦‚æœè¶…æ—¶å°±ä¼šprintä¸€ä¸ªerrorè€Œä¸”ä¸€ç›´é€’å½’ä¸‹å»ï¼Œå¾ªç¯ä¹Ÿä¸ä¼šbreakäº†ã€‚çˆ¬ç½‘é¡µå¿…å¤‡å•Š~
# ä»£ç 

```python
from bs4 import BeautifulSoup
from urllib.request import urlopen
import re
#import webbrowser

base_url = "http://qq.ip138.com"
city = ["train/"]
answer=[]

#his = his.encode('uft-8')

    #url = base_url + his[-1]
html = urlopen("http://qq.ip138.com/train").read().decode('GB2312')
#print(html)
#webbrowser.open(url)
soup = BeautifulSoup(html,features='lxml')

#print(soup.find('a').get_text(),'\nåç¼€ï¼š',city[0])
#æ‰¾åˆ° å±æ€§hrefæ˜¯/train/å¼€å¤´ çš„ aæ ‡ç­¾
province = soup.find_all('a',{"href":re.compile("/train/")})
def fun(url):
    result=''
    try:
        result = urlopen(url,timeout=10).read()
    except:
        result = fun(url)
        print('error')
    return result
print(province)
for i in province[1:-1]:
    print(i['href'])
    url = base_url+i['href']
    html = fun(url)
    soup = BeautifulSoup(html,features='lxml')
    #è¯»æ¯ä¸ªçœé‡Œçš„åŸå¸‚
    
    city = soup.find_all('a',{"href":re.compile(i['href'])})
    #flagè¿™ä¸ªçœ
    
    flag = i['href']
    for i in city[1:-1]:
        #å“ˆå“ˆã€‚ç»ˆäºè¯»åˆ°æ—¶åˆ»è¡¨äº†
        print(i['href'])
        url = base_url+i['href']
        html = fun(url)
        soup = BeautifulSoup(html,features='lxml')
        train = soup.find_all('tr')
        p=re.compile(r'13:14')
        
        for i in train:
            if p.search(str(i)):
                if i.text.split()[3] == '13:14':
                    answer.append(i.text)

```

## è¿è¡Œç»“æœ
![](http://p66eruxmw.bkt.clouddn.com/15266453453241.jpg)

## æ”¶å°¾å·¥ä½œ

åŸæ¥æœ‰å¥½å¤šå¥½å¤šç¬¦åˆæ¡ä»¶çš„åˆ—è½¦å‘€ï¼Œé‚£ä¹ˆä½œä¸ºèŠ±(Qiong)æœµï¼ˆRenï¼‰çš„æˆ‘æ€ä¹ˆé€‰å‘¢ã€‚

å“ˆå“ˆã€‚å½“ç„¶æ˜¯ç”¨åˆ°ç«™æ—¶é—´-å‘è½¦æ—¶é—´è®¡ç®—å‡ºæœ€ï¼ˆPianyiï¼‰çš„é‚£ä¸€è¾†å•¦ã€‚
è¿™é‡Œåˆå­¦åˆ°äº†Pythonçš„timeåŒ…ã€‚
ç»™ä½ ä»¬ä¸ªæ¨¡æ¿æ‹¿å»ç”¨ï¼š

```python
import time
#ç»åœæ—¶é—´æ˜¯ç¬¬å…­åˆ—
t1 = time.mktime(time.strptime(i.split()[6],'%H:%m')
#åˆ°ç«™æ—¶é—´æ˜¯æœ€åä¸€åˆ—
t2 = time.mktime(time.strptime(i.split()[-1],'%H:%m')

t2- t1
```

æœ€åæˆ‘ä¹°äº†è¿™ä¸€ç­ï¼š

![](http://p66eruxmw.bkt.clouddn.com/15266457689435.jpg)


å“ˆå“ˆï¼Œæ˜å¤©æŠ½ä¸ªç©ºå»å–ç¥¨å»~


